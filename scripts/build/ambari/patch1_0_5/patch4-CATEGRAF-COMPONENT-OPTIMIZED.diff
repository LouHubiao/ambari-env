Subject: [PATCH] feature：支持 categraf 使用 pidod 方式完成 组件重载
fixed: 修复了categraf 重启组件时 未正确映射端口号的问题
---
Index: ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_client.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_client.py b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_client.py
--- a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_client.py	(revision 6c0258366d45755b67ab1aebf5b53dc6f6a6c97f)
+++ b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_client.py	(date 1737621540064)
@@ -88,6 +88,11 @@

         return [params.categraf_pid_file]

+    def pidrefresh(self, env):
+        import params
+        env.set_params(params)
+        self.configure(env)
+        categraf_service("server", action="hup")

 if __name__ == "__main__":
     CategrafClient().execute()
Index: ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_service.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_service.py b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_service.py
--- a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_service.py	(revision 6c0258366d45755b67ab1aebf5b53dc6f6a6c97f)
+++ b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/categraf_service.py	(date 1737621657612)
@@ -1,4 +1,5 @@
 #!/usr/bin/env python
+# coding=utf-8
 """
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
@@ -46,12 +47,13 @@
     import status_params

     wait_time = 5
+    max_retries = 10  # 最大轮询次数
     if name == "server":
         pid_file = params.categraf_pid_file
-        cmd_start = "cd {0};nohup {0}/categraf --start > {1}/categraf.log 2>&1 < /dev/null &".format(
+        cmd_start = "{0}/categraf --start > {1}/categraf.log".format(
             params.categraf_home, params.categraf_log_dir
         )
-        cmd_stop = "cd {0};{0}/categraf --stop".format(params.categraf_home)
+        cmd_stop = "{0}/categraf --stop".format(params.categraf_home)
     pid = get_user_call_output.get_user_call_output(
         format("cat {pid_file}"), user=params.categraf_user, is_checked_call=False
     )[1]
@@ -61,14 +63,28 @@

     if action == "start":
         daemon_cmd = cmd_start
-
         try:
-            Execute(
-                daemon_cmd, user=params.categraf_user, not_if=process_id_exists_command
-            )
-            Execute(params.categraf_pid_cmd, user=params.categraf_user)
-        except:
+            # 执行启动命令
+            Execute(daemon_cmd, user=params.categraf_user)
+            # 轮询检查进程是否启动并提取实际 PID
+            for retry in range(max_retries):
+                time.sleep(wait_time)  # 等待指定时间
+                Execute(params.categraf_pid_cmd, user=params.categraf_user)  # 执行命令提取 PID
+                pid = get_user_call_output.get_user_call_output(
+                    "cat {0}".format(pid_file), user=params.categraf_user, is_checked_call=False
+                )[1]
+
+                # 检查 PID 是否有效
+                if pid and os.path.exists(pid_file):
+                    Logger.info("Categraf service started successfully with PID: {0}".format(pid))
+                    break
+                else:
+                    Logger.info("Categraf service waiting start ")
+            else:
+                raise Fail("Categraf failed to start within the maximum wait time.")
+        except Exception as e:
             show_logs(params.categraf_log_dir, user=params.categraf_user)
+            Logger.error("Failed to start Categraf service: {0}".format(str(e)))
             raise

     elif action == "stop":
@@ -100,3 +116,10 @@
             raise

         File(pid_file, action="delete")
+
+    elif action == "hup":
+        Execute(
+            "kill -HUP `pidof categraf`",
+            user=params.categraf_user
+        )
+        Logger.info("hup finish!")
Index: ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/metainfo.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/metainfo.xml b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/metainfo.xml
--- a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/metainfo.xml	(revision 6c0258366d45755b67ab1aebf5b53dc6f6a6c97f)
+++ b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/metainfo.xml	(date 1737621396863)
@@ -17,84 +17,96 @@
 */
 -->
 <metainfo>
-  <schemaVersion>2.0</schemaVersion>
-  <services>
-    <service>
-      <name>NIGHTINGALE</name>
-      <displayName>Nightingale</displayName>
-      <comment>Component NIGHTINGALE Integrated By JaneTTR . For commercial use, please contact mail: 3832514048@qq.com</comment>
-      <version>7.3.4</version>
-      <components>
-        <component>
-          <name>NIGHTINGALE_SERVER</name>
-          <displayName>Nightingale Server</displayName>
-          <category>MASTER</category>
-          <cardinality>1+</cardinality>
-          <versionAdvertised>true</versionAdvertised>
-          <commandScript>
-            <script>scripts/server.py</script>
-            <scriptType>PYTHON</scriptType>
-            <timeout>600</timeout>
-          </commandScript>
-          <configuration-dependencies>
-            <config-type>nightingale-env</config-type>
-            <config-type>nightingale</config-type>
-          </configuration-dependencies>
-          <logs>
-            <log>
-              <logId>nightingale</logId>
-              <primary>true</primary>
-            </log>
-          </logs>
-        </component>
+    <schemaVersion>2.0</schemaVersion>
+    <services>
+        <service>
+            <name>NIGHTINGALE</name>
+            <displayName>Nightingale</displayName>
+            <comment>Component NIGHTINGALE Integrated By JaneTTR . For commercial use, please contact mail:
+                3832514048@qq.com
+            </comment>
+            <version>7.3.4</version>
+            <components>
+                <component>
+                    <name>NIGHTINGALE_SERVER</name>
+                    <displayName>Nightingale Server</displayName>
+                    <category>MASTER</category>
+                    <cardinality>1+</cardinality>
+                    <versionAdvertised>true</versionAdvertised>
+                    <commandScript>
+                        <script>scripts/server.py</script>
+                        <scriptType>PYTHON</scriptType>
+                        <timeout>600</timeout>
+                    </commandScript>
+                    <configuration-dependencies>
+                        <config-type>nightingale-env</config-type>
+                        <config-type>nightingale</config-type>
+                    </configuration-dependencies>
+                    <logs>
+                        <log>
+                            <logId>nightingale</logId>
+                            <primary>true</primary>
+                        </log>
+                    </logs>
+                </component>

-        <component>
-          <name>CATEGRAF</name>
-          <displayName>Categraf</displayName>
-          <category>SLAVE</category>
-          <cardinality>ALL</cardinality>
-          <versionAdvertised>true</versionAdvertised>
-          <commandScript>
-            <script>scripts/categraf_client.py</script>
-            <scriptType>PYTHON</scriptType>
-          </commandScript>
-          <configuration-dependencies>
-            <config-type>categraf</config-type>
-            <config-type>categraf-env</config-type>
-          </configuration-dependencies>
-        </component>
-      </components>
+                <component>
+                    <name>CATEGRAF</name>
+                    <displayName>Categraf</displayName>
+                    <category>SLAVE</category>
+                    <cardinality>ALL</cardinality>
+                    <versionAdvertised>true</versionAdvertised>
+                    <commandScript>
+                        <script>scripts/categraf_client.py</script>
+                        <scriptType>PYTHON</scriptType>
+                    </commandScript>
+                    <configuration-dependencies>
+                        <config-type>categraf</config-type>
+                        <config-type>categraf-env</config-type>
+                    </configuration-dependencies>
+                    <customCommands>
+                        <customCommand>
+                            <name>PIDREFRESH</name>
+                            <commandScript>
+                                <script>scripts/categraf_client.py</script>
+                                <scriptType>PYTHON</scriptType>
+                                <timeout>600</timeout>
+                            </commandScript>
+                        </customCommand>
+                    </customCommands>
+                </component>
+            </components>


-      <commandScript>
-        <script>scripts/service_check.py</script>
-        <scriptType>PYTHON</scriptType>
-        <timeout>300</timeout>
-      </commandScript>
+            <commandScript>
+                <script>scripts/service_check.py</script>
+                <scriptType>PYTHON</scriptType>
+                <timeout>300</timeout>
+            </commandScript>

-      <restartRequiredAfterChange>true</restartRequiredAfterChange>
+            <restartRequiredAfterChange>true</restartRequiredAfterChange>

-      <osSpecifics>
-        <osSpecific>
-          <osFamily>any</osFamily>
-          <packages>
-            <package>
-              <name>nightingale_${stack_version}</name>
-            </package>
-            <package>
-              <name>categraf_${stack_version}</name>
-            </package>
-          </packages>
-        </osSpecific>
-      </osSpecifics>
+            <osSpecifics>
+                <osSpecific>
+                    <osFamily>any</osFamily>
+                    <packages>
+                        <package>
+                            <name>nightingale_${stack_version}</name>
+                        </package>
+                        <package>
+                            <name>categraf_${stack_version}</name>
+                        </package>
+                    </packages>
+                </osSpecific>
+            </osSpecifics>

-      <quickLinksConfigurations>
-        <quickLinksConfiguration>
-          <fileName>quicklinks.json</fileName>
-          <default>true</default>
-        </quickLinksConfiguration>
-      </quickLinksConfigurations>
+            <quickLinksConfigurations>
+                <quickLinksConfiguration>
+                    <fileName>quicklinks.json</fileName>
+                    <default>true</default>
+                </quickLinksConfiguration>
+            </quickLinksConfigurations>

-    </service>
-  </services>
+        </service>
+    </services>
 </metainfo>
Index: ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/params.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/params.py b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/params.py
--- a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/params.py	(revision 6c0258366d45755b67ab1aebf5b53dc6f6a6c97f)
+++ b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/NIGHTINGALE/package/scripts/params.py	(date 1737619331401)
@@ -205,12 +205,12 @@
 categraf_pid_file = "{}/categraf.pid".format(categraf_pid_dir)

 categraf_pid_cmd = (
-        "echo `ps -A -o pid,command | grep -v  grep | grep categraf | awk '{print $1; exit}'`> "
+        "echo `ps -A -o pid,command | grep -v  grep | grep 'categraf -configs' | awk '{print $1; exit}'`> "
         + categraf_pid_file
 )

 categraf_test_cmd = (
-    "ps -A -o pid,command | grep -v  grep | grep categraf | awk '{print $1; exit}'"
+    "ps -A -o pid,command | grep -v  grep | grep 'categraf -configs' | awk '{print $1; exit}'"
 )

 nightingale_server_hosts = config["clusterHostInfo"]["nightingale_server_hosts"]
Index: ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/CLOUDBEAVER/configuration/cloudbeaver.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/CLOUDBEAVER/configuration/cloudbeaver.xml b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/CLOUDBEAVER/configuration/cloudbeaver.xml
--- a/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/CLOUDBEAVER/configuration/cloudbeaver.xml	(revision 6c0258366d45755b67ab1aebf5b53dc6f6a6c97f)
+++ b/ambari-server/src/main/resources/stacks/BIGTOP/3.2.0/services/CLOUDBEAVER/configuration/cloudbeaver.xml	(date 1737595127060)
@@ -139,7 +139,7 @@
     </property>
     <property require-input="true">
       <name>server.database.driver</name>
-        <value/>
+        <value>postgres-jdbc</value>
       <description>postgres-jdbc</description>
     </property>
     <property require-input="true">
